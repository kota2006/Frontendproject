name: Ensure GitHub Pages is enabled

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  enable-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Configure job
        run: echo "Ensuring GitHub Pages is configured for gh-pages branch"

      - name: Create/Update Pages site via REST API
        env:
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          owner=${GITHUB_REPO%%/*}
          repo=${GITHUB_REPO##*/}
          echo "Owner: $owner, Repo: $repo"
          body='{"source":{"branch":"gh-pages","path":"/"}}'
          echo "Request body: $body"
          # Use GitHub REST API to create or update Pages site; print response for debug
          http_code=$(curl -sS -w "%{http_code}" -o /tmp/pages_resp.txt -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "$body" \
            "https://api.github.com/repos/$owner/$repo/pages") || true
          echo "--- response body ---"
          cat /tmp/pages_resp.txt || true
          echo "--- end response ---"
          echo "HTTP status: $http_code"
          if [ "$http_code" != "201" -a "$http_code" != "202" -a "$http_code" != "200" ]; then
            echo "Pages API request did not return success status: $http_code"
            exit 1
          fi
